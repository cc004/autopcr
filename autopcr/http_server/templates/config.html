<!DOCTYPE html>
<html>

<!-- TODO -->
<!-- 值更新 -->
<!-- put的js -->
<!-- 公共变量特殊背景颜色标识 -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPCR-主界面</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/css/Switch.css" />
    <script src="/static/js/iecheck.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .cart-area {
            margin-top: 5%;
            margin-bottom: 5%;
        }

        .config-section {
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .config-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .config-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 0px 20px;
        }

        .config-info > .form-group {
            width: 256px;
            margin-bottom: 0px;
        }

        .button-group .btn {
            margin-top: 4px;
        }

        .copy-text {
            font-size: 8px;
            user-select: all;
            cursor: pointer;
            max-width: 520px;
            }

        #ta td:nth-child(5) {
            min-width: 150px;
        }

        .form-text-red {
            color: red;
        }
    </style>
</head>

<body>
    <main>
        <div class="cart-area">
            <div class="container">
                <div class="row justify-content-center">
                    <div id="card" class="col-md-10">
                        <div class="config-section">
                            <div id="alertContainer" class="alert-container"></div>
                            <h3 class="config-header">配置信息：</h3>
                            <div class="config-info">
                                <div class="form-group">
                                    <label>一般配置：</label>
                                    <input type="text" class="form-control" id="alian" placeholder="昵称" />
                                    <input type="text" class="form-control" id="qq" placeholder="QQ号" style="margin-top: 10px;" />
                                </div>
                                <div class="form-group">
                                    <label>账号配置：</label>
                                    <input type="text" class="form-control" id="username" placeholder="PCR登录用户名" />
                                    <input type="text" class="form-control" id="password" placeholder="PCR登录密码" style="margin-top: 10px;" />
                                </div>
                            </div>
                            <small id="account-description" class="form-text form-text-red">注意：本服务需要存储您的用户名和密码以正常运行。若不同意存储，请勿使用。</small>
                            <div class="button-group" style="margin-top: 0px;">
                                <button type="button" class="btn btn-primary" id="login" onclick="selectOnChange()">保存配置信息</button>
                                <button type="button" class="btn btn-primary" id="do_task" onclick="do_task()">执行清日常</button>
                                <button type="button" class="btn btn-primary" id="library_import" onclick="library_import()">生成兰德索尔图书馆导入文本</button>
                                <button type="button" class="btn btn-danger" id="delete_config" onclick="delete_config()">删除账号信息</button>
                            </div>
                            <div id="msg-group" style="margin-top: 4px; margin-bottom: 8px">
                                <small id="msg-description" class="form-text" style="display: none;">↓导入文本↓点击复制↓&ensp;<a href="https://pcredivewiki.tw/Armory" target="_blank">兰德索尔图书馆</a></small>
                                <div id="msg-input-group" class="input-group" style="margin-top: 2px; margin-bottom: 6px; display: none;">
                                    <input id="msg" type="text" class="form-control copy-text" value="value" readonly onclick="copyToClipboard()">
                                </div>
                            </div>
                            <div id="module">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/isotope.pkgd.min.js"></script>
    <script src="/static/js/imagesloaded.pkgd.min.js"></script>
    <script src="/static/js/jquery.magnific-popup.min.js"></script>
    <script src="/static/js/jquery.countdown.min.js"></script>
    <script src="/static/js/jquery-ui.min.js"></script>
    <script src="/static/js/slick.min.js"></script>
    <script src="/static/js/ajax-form.js"></script>
    <script src="/static/js/wow.min.js"></script>
    <script src="/static/js/aos.js"></script>
    <script src="/static/js/plugins.js"></script>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/bootbox.min.js"></script>

    <script type="text/javascript">
        var prompt = function (message, style, time) {
            style = style === undefined ? "alert-success" : style;
            time = time === undefined ? 3000 : time;

            var alertBox = $('<div class="alert" role="alert"></div>')
                .addClass(style)
                .text(message)
                .css({
                    position: "absolute",
                    "z-index": 99999,
                    });
            $('#alertContainer').append(alertBox);
            alertBox.hide().slideDown();
            setTimeout(function() {
                alertBox.slideUp(function() {
                $(this).remove();
                });
            }, time);

        };
        // 成功提示
        var success_prompt = function (message, time) {
            prompt(message, "alert-success", time);
        };

        // 失败提示
        var fail_prompt = function (message, time) {
            prompt(message, "alert-danger", time);
        };

        // 提醒
        var warning_prompt = function (message, time) {
            prompt(message, "alert-warning", time);
        };

        // 信息提示
        var info_prompt = function (message, time) {
            prompt(message, "alert-info", time);
        };

        // 信息提示
        var alert_prompt = function (message, time) {
            prompt(message, "alert-primary", time);
        };

        function suspend(str, message = "") {
            // document.scrollingElement.scrollTop = 0; //让页面滚动到最顶部
            switch (str) {
                case "alert-success":
                    success_prompt(message != "" ? message : "提交成功");
                    break;
                case "alert-warning":
                    warning_prompt(message != "" ? message : "错误警告");
                    break;
                case "alert-danger":
                    fail_prompt(message != "" ? message : "提交失败");
                    break;
                case "alert-info":
                    info_prompt(message != "" ? message : "未查询到数据");
                    break;
                case "alert-info2":
                    info_prompt(message != "" ? message : "未查询到数据");
                    break;
                default:
                    alert_prompt("未查询到数据");
            }
        }
    </script>

    <script type="text/javascript" charset="utf-8">
        
        var user_config = {}

        $(document).ready(function () {
            $.ajax({
                url: "/daily/api/config" + window.location.search,
                type: "get",
                processData: false,
                success: function (ret) {
                    let ta_tab = $("#module");
                    $("#alian").val(ret.alian);
                    $("#qq").val(ret.qq);
                    $("#username").val(ret.username);
                    $("#password").val(ret.password);
                    res = ret.last_result;
                    user_config = ret.config;
                    ret = ret.data;

                    for (let i = 0; i < ret.length; ++i) {
                        let val = ret[i];

                        ta_tab.append(make_card(val)); //添加一列
                    }
                    load_result(res);
                },
                error: function (ret) {
                    suspend("alert-danger", "获取配置失败");
                },
            });
        }
        );

        function get_single_html(config) {
            let res = `<select class="custom-select" id=${config.key} onchange="selectOnChange(this)">`;
            for (let i = 0; i < config.candidates.length; i++) res += `<option value='${config.candidates[i]}' ${user_config[config.key] == config.candidates[i] ? "selected" : ""}>${config.candidates[i]}</option>`;
            res += "</select>";
            return res;
        }

        function get_bool_html(config) {
            return `<input type="checkbox" class="switch" ${user_config[config.key] ? 'checked="checked"' : ""} id=${config.key} name=${config.key} onclick="checkboxOnclick(this)" />`;
        }

        function get_int_html(config) {
            return `<input type="text" id=${config.key} value=${user_config[config.key]} class="form-control" placeholder=${config.candidates[0]}-${config.candidates[config.candidates.length-1]}`;
        }
        function get_multi_html(config) {
            let res = `<select class="custom-select" multiple id=${config.key} onchange="selectOnChange(this)">`;
            for (let i = 0; i < config.candidates.length; i++) res += `<option value='${config.candidates[i]}' ${user_config[config.key] == config.candidates[i] ? "selected" : ""}>${config.candidates[i]}</option>`;
            res += "</select>";
            return res;
        }
        function get_time_html(config) {
            return `<input type="time" class="form-control" id=${config.key} value=${user_config[config.key]} onchange="selectOnChange(this)" />`;
        }


        function generate_option_HTML(config){
            
          switch (config.config_type) {
            case 'single':
                return get_single_html(config)
                break;

            case 'multi':
                return get_multi_html(config)
                break;

            case 'int':
                return get_int_html(config)
                break;

            case 'bool':
                return get_bool_html(config)
                break;

            case 'time':
                return get_time_html(config)
                break;

            }
        }

        function generate_config_HTML(config){
            let configHTML = '';
            configHTML += `
                <div class="mb-3">
                  <h6>${config.desc}</h6>
                  ${generate_option_HTML(config)}
                </div>
              `;
              return configHTML;
        }

        function make_card(m) {

            let functionHTML = `
                  <div id=card_${m.key} class="card">
                    <div class="card-header">
                      <h5 class="mb-0"> <input type="checkbox" class="switch" ${user_config[m.key] ? 'checked="checked"' : ""} id=${m.key} name=${m.key} onclick="checkboxOnclick(this)" /> ${m.name} </h5>
                    </div>
                    <div class="card-body">
                      ${m.description}
            `;

            console.log(m)
            for (const key in m.config) {
                functionHTML += generate_config_HTML(m.config[key]);
            }

            functionHTML += `
                        </div>
                    </div>
            `;

            return functionHTML;

        }

        
        function load_result(ret) {
            for (id in ret) {
                let name = ret[id]['name']
                $(`#result_${name}`).html(ret[id]["msg"].replace(/\n/g, '<br>'))
            }
        }

        function library_import() {
            $("#library_import").attr('disabled', true);
            suspend("alert-info", "已开始执行任务。");
            $.ajax({
                url: '/daily/api/library_import' + window.location.search,
                type: 'get',
                processData: false,
                success: function (ret) {
                    $("#msg").attr('value', ret)
                    $("#msg-group").css('margin-top', '0');
                    $("#msg-description").css('display', '');
                    $("#msg-input-group").css('display', '');
                    $("#library_import").attr('disabled', false);
                    suspend("alert-success", "任务执行成功！");
                },
                error: function (ret) {
                    suspend("alert-danger", "执行任务失败: " + ret.responseText);
                    $("#library_import").attr('disabled', false);
                }
            })
        }

        function delete_config() {

            var confirmed = confirm('确定要删除该账号？该操作不可撤销！');

            if (confirmed){
                $("#delete_config").attr('disabled', true);
                suspend("alert-info", "已开始执行任务。");
                $.ajax({
                    url: '/daily/api/config' + window.location.search,
                    type: 'delete',
                    processData: false,
                    success: function (ret) {
                        suspend("alert-success", "删除账号成功！");
                        window.location.href = "/daily/";
                    },
                    error: function (ret) {
                        suspend("alert-danger", "删除账号失败: " + ret.responseText);
                        $("#delete_config").attr('disabled', false);
                    }
                })
            }
        }

        function do_task() {
            $("#do_task").attr('disabled', true);
            suspend("alert-info", "已开始执行清日常任务。");
            $.ajax({
                url: '/daily/api/do_task' + window.location.search,
                type: 'get',
                processData: false,
                success: function (ret) {
                    // <!-- prompt(JSON.stringify(ret), "alert-success", 60000); -->
                    suspend("alert-success", "清日常任务执行完毕。");
                    $("#do_task").attr('disabled', false);
                    load_result(ret);
                },
                error: function (ret) {
                    suspend("alert-danger", "执行任务失败: " + ret.responseText);
                    $("#do_task").attr('disabled', false);
                }
            })
        }

        function selectOnChange() {
            update_new();
        }

        function checkboxOnclick(checkbox) {
            const key = checkbox.id;
            const value = checkbox.checked;
            user_config[key] = value;

            update_new();
        }

        function update_new() {
            let config = {}; // 可以用referrer解决问题
            id = 1;
            config['alian'] = $("#alian").val();
            config['qq'] = $("#qq").val();
            config['username'] = $("#username").val();
            config['password'] = $("#password").val();

            while ($(`#name${id}`).length) {
                config[$(`#name${id}`).text()] = ($(`#enum${id} option:selected`).length ? $(`#enum${id} option:selected`).text() : $(`[id^=bool${id}]`)[0].checked);
                id += 1;
            }
            $.ajax({
                url: "/daily/api/config" + window.location.search,
                type: "put",
                data: JSON.stringify(config),
                contentType: "application/json;charset=utf-8",
                processData: false,
                success: function (ret) {
                    if (ret.statusCode == 200) {
                        suspend("alert-success", ret.message);
                    } else {
                        alert("本次修改保存失败：" + ret.message + "\n如有需要，请联系管理员\n点击确定将为您刷新页面");
                        location.reload(true);
                    }
                },
                error: function (ret) {
                    suspend("alert-danger", "本次修改保存失败");
                },
            });
        }
    </script>
    <script>
        function copyToClipboard() {
        var copyText = document.getElementById("msg");
        copyText.select();
        copyText.setSelectionRange(0, 99999); /* 兼容移动设备 */
        document.execCommand("copy");
        suspend("alert-success", "内容已复制到剪贴板！");
        }
    </script>
</body>

</html>
